\documentclass{article}

\input{macros}
\usepackage{enumitem}
\usepackage{caption}

\begin{document}
  \section{Python Language Grammar}
  % This grammar is based on the AST defined in the python2_ast.ml file

  We use the convention that a symbol with a star above it is optional.

  \begin{grammar}
    \grule[variables]{\pvariable}{}
    \grule[suites]{\psuite}{\gtobrk \pstmt; \ldots \gtcbrk}
    \grule[statements]{\pstmt}{
                \gtdef \gtopar \pexpr, \ldots \gtcpar \gtcolon \psuite \gline
        \gor    \gtreturn \pexpropt \gline
        \gor    \pexpr, \ldots \pexpr \gteq \pexpr \gline
        \gor    \pexpr \pbinop\gteq \pexpr \gline
        %I really don't care about print statements so I'm ignoring them
        \gor    \gtfor \pexpr \gtin \pexpr \gtcolon \psuite \gline
        \gor    \gtwhile \pexpr \gtcolon \psuite \gline
        \gor    \gtif \pexpr \gtcolon \psuite \gtelse \gtcolon \psuite \gline
        \gor    \gtraise \pexpropt, \pexpropt, \pexpropt \gline
        \gor    \gttry \gtcolon \psuite \gtobrk \pexcepthandler; \ldots \gtcbrk \gline
        \gor    \pexpr \gline
        \gor    \gtpass \gline
        \gor    \gtbreak \gline
        \gor    \gtcontinue \gline
    }
    \grule[expressions]{\pexpr}{
                \punop \pexpr \gline
        \gor    \pexpr \pbinop \pexpr \gline
        \gor    \pexpr \gtand \pexpr \gline
        \gor    \pexpr \gtor \pexpr \gline
        \gor    \pexpr \pcmpop \pexpr \gline
        \gor    \pexpr \gtif \pexpr \gtelse \pexpr \gline
        \gor    \pexpr \gtopar \pexpr, \dots \gtcpar \gline
        \gor    \pnum \gline
        \gor    \mathbb{S} \gline
        \gor    \mathbb{B} \gline
        \gor    \pexpr.\pvariable \gline
        \gor    \pexpr \gtobrk \pslice \gtcbrk \gline
        \gor    \pvariable \gline
        \gor    \gtobrk \pexpr, \dots \gtcbrk \gline
        \gor    \gtopar \pexpr, \dots \gtcpar \gline
        \gor    \gtNone \gline
    }
    \grule[unary operators]{\punop}{
                \gtuplus
           \gor \gtusub
           \gor \gtnot
    }
    \grule[binary operators]{\pbinop}{
                \gtplus
           \gor \gtsub
           \gor \gtmult
           \gor \gtdiv
           \gor \gtmod
           \gor \gtpow
    }
    \grule[comparison operators]{\pcmpop}{
                \gtiseq
           \gor \gtneq
           \gor \gtgeq
           \gor \gtleq
           \gor \gtge
           \gor \gtle
           \gor \gtis
           \gor \gtis \gtnot
           \gor \gtin
           \gor \gtnot \gtin
    }
    \grule[exception handlers]{\pexcepthandler}{
                \gtexcept \gtcolon \psuite \gline
           \gor \gtexcept \pexpr \gtcolon \psuite \gline
           \gor \gtexcept \pexpr \gtas \pexpr \gtcolon \psuite
    }
    \grule[slice]{\pslice}{
                \pexpr \gline
           \gor \pexpropt \gtcolon \pexpropt \gline
           \gor \pexpropt \gtcolon \pexpropt \gtcolon \pexpropt
    }
    \grule[numbers]{\pnum}{}
    \grule[strings]{\mathbb{S}}{}
    \grule[booleans]{\mathbb{B}}{
                \ostrue
        \gor    \osfalse
    }
  \end{grammar}

  \section{Python Simplified Grammar}
  % This grammar is based on the AST defined in the python2_ast.ml file

  \begin{grammar}
    \grule[variables]{\pvariable}{}
    \grule[suites]{\psuite}{\gtobrk \pstmt; \ldots \gtcbrk}
    \grule[statements]{\pstmt}{
                \gtreturn \pexpr \gline
        \gor    \pvariable \gteq \pexpr \gline
        \gor    \gtwhile \pvariable \gtcolon \psuite \gline
        \gor    \gtif \pexpr \gtcolon \psuite \gtelse \gtcolon \psuite \gline
        \gor    \gtraise \pexpr \gline
        \gor    \gttry \gtcolon \psuite \gtexcept \pvariable \gtcolon \psuite \gline
        \gor    \gtpass \gline
        \gor    \gtbreak \gline
        \gor    \gtcontinue \gline
        \gor    \pexpr \gline
    }
    \grule[expressions]{\pexpr}{
                \punop \pexpr \gline
        \gor    \pexpr \pbinop \pexpr \gline
        \gor    \pexpr \gtopar \pexpr, \dots \gtcpar \gline
        \gor    \pexpr.\pvariable \gline
        \gor    \gtobrk \pexpr, \dots \gtcbrk \gline
        \gor    \gtopar \pexpr, \dots \gtcpar \gline
        \gor    \pnum \gline
        \gor    \mathbb{S} \gline
        \gor    \mathbb{B} \gline
        \gor    \pvariable \gline
        \gor    \gtfun \gtopar \pexpr, \ldots \gtcpar \gtcolon \psuite \gline
        \gor    \pmagic
    }
    \grule[unary operators]{\punop}{
                \gtnot
    }
    \grule[binary operators]{\pbinop}{
                \gtis
    }
    \grule[numbers]{\pnum}{}
    \grule[strings]{\mathbb{S}}{}
    \grule[booleans]{\mathbb{B}}{
                \ostrue
        \gor    \osfalse
    }
    \grule[magic builtins]{\pmagic}{
                \gtbool
           \gor \gtslice
           \gor \gtValueError
           \gor \gtAttributeError \gline
           \gor \gtTypeError
           \gor \gtStopIteration
    }
  \end{grammar}

\section{Python Simplification Process}

In the following rules, the expression ``\tfreshvar'' will indicate a fresh variable name.
Identical expressions in a single rule will all refer to the same variable name.

The left-hand side of each rule is in the Python language, while the right-hand side is
in the the Simplified language.

\begin{mathpar}
  \translationRule{Function Definition}{
    \pexpr_i = \pvariable_i \\ \psuite' = \osFunc{add\_return}(\psuite)
  }{
    \gtdef \gtopar \pexpr_0, \ldots, \pexpr_n \gtcpar \gtcolon \psuite
  }{
    \gtobrk \tfreshvar \gteq
    \gtfun \gtopar \pvariable_0, \ldots, \pvariable_n \gtcpar
    \gtcolon \meaningof{\psuite'} \gtcbrk
  }
\end{mathpar}

\begin{mathpar}
  \translationRule{Return Expression}{
    \meaningof{\pexpr} = \gsLR{\psuite, \pexpr'}
  }{
    \gtreturn \pexpr
  }{
    \psuite \listConcat \gtobrk \gtreturn \pexpr' \gtcbrk
  }
\end{mathpar}

\begin{mathpar}
  \translationRule{Empty Return}{
    % No premises
  }{
    \gtreturn
  }{
    \gtobrk \gtreturn \star\gtNone \gtcbrk
  }
\end{mathpar}

\begin{mathpar}
  \translationRule{Multiple Assignment}{
    n > 1 \\ \meaningof{\pexpr} = \gsLR{\psuite, \pexpr'}
  }{
    \pexpr_1 \gteq \ldots \gteq \pexpr_n \gteq \pexpr
  }{
    \psuite \listConcat \gtobrk \tfreshvar \gteq \pexpr' \gtcbrk
    \listConcat \meaningof{\pexpr_1 \gteq \tfreshvar} \listConcat \ldots
    \listConcat \meaningof{\pexpr_n \gteq \tfreshvar}
  }
\end{mathpar}

\begin{mathpar}
  \translationRule{Variable Assignment}{
    \meaningof{\pexpr} = \gsLR{\psuite, \pexpr'}
  }{
    \pvariable \gteq \pexpr
  }{
    \psuite \listConcat \gtobrk \pvariable \gteq \pexpr' \gtcbrk
  }
\end{mathpar}

\begin{mathpar}
  \translationRule{Attribute Assignment}{
    \meaningof{\pexpr_1} = \gsLR{\psuite_1, \pexpr_1'} \\
    \meaningof{\pexpr_2} = \gsLR{\psuite_2, \pexpr_2'} \\
    s = \osFunc{string\_of\_variable}(\pvariable)
  }{
    \pexpr_1.\pvariable \gteq \pexpr_2
  }{
    \psuite_1 \listConcat \psuite_2 \listConcat \gtobrk
    \pexpr_1'.\_\_setattr\_\_ \gtopar s, \pexpr_2' \gtcpar \gtcbrk
  }
\end{mathpar}

\begin{mathpar}
  \translationRule{Slice Assignment}{
    \meaningof{\pexpr_1} = \gsLR{\psuite_1, \pexpr_1'} \\
    \meaningof{\pexpr_2} = \gsLR{\psuite_2, \pexpr_2'} \\
    \meaningof{\pslice}  = \gsLR{\psuite_3, \pexpr_3'} \\
  }{
    \pexpr_1 \gtobrk \pslice \gtcbrk \gteq \pexpr_2
  }{
    \psuite_1 \listConcat \psuite_2 \listConcat \gtobrk
    \pexpr_1'.\_\_setitem\_\_ \gtopar \pexpr_3', \pexpr_2' \gtcpar \gtcbrk
  }
\end{mathpar}

\begin{mathpar}
  \translationRule{List Assignment}{
  }{
    \gtobrk \pvariable_1, \ldots, \pvariable_n \gtcbrk \gteq \pexpr
  }{
    \meaningof{\gtopar \pvariable_1, \ldots, \pvariable_n \gtcpar \gteq \pexpr}
  }
\end{mathpar}

\begin{mathpar}
  \translationRule{Tuple Assignment}{
  }{
    \gtopar \pvariable_1, \ldots, \pvariable_n \gtcpar \gteq \pexpr
  }{
    I cry evertim
  }
\end{mathpar}

\begin{mathpar}
  \translationRule{Augmented Variable Assignment}{
    \meaningof{\pexpr} = \gsLR{\psuite, \pexpr'} \\
    f = \osFunc{binop\_to\_func}(\pbinop) \\
    f_i = \osFunc{binop\_to\_ifunc}(\pbinop)
  }{
    \pvariable \pbinop \gteq \pexpr
  }{
    %\psuite \listConcat \gtobrk \pvariable \gteq \pexpr' \gtcbrk
    Complicated stuff
  }
\end{mathpar}

\end{document}
